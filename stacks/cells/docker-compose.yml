# AIOS Cell Stack - Peer-to-Peer Consciousness Nodes
# Deploy AIOS cells with automatic peer discovery and consciousness synchronization
# This stack runs on both machines, creating a distributed peer-to-peer network

services:
  # Cell Discovery Service
  discovery-service:
    image: aios-discovery:latest
    container_name: aios-discovery
    restart: unless-stopped
    networks:
      - aios-cells
      - aios-dendritic-mesh
    ports:
      - "0.0.0.0:8001:8001"  # Discovery API
    environment:
      - DISCOVERY_PORT=8001
      - CELL_ID=discovery
    volumes:
      - ./discovery/discovery.py:/app/discovery.py:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # VSCode Copilot Agent Bridge - connects to desktop AIOS cell
  vscode-agent-bridge:
    image: aios-vscode-bridge:latest
    container_name: aios-vscode-bridge-laptop
    restart: unless-stopped
    networks:
      - aios-cells
    ports:
      - "0.0.0.0:3001:3001"  # VSCode extension API
    environment:
      - AIOS_DISCOVERY_ADDR=aios-discovery:8001
      - AIOS_VAULT_ADDR=http://192.168.1.128:8200,http://aios-laptop.local:8200
      - BRIDGE_PORT=3001
      # Note: AIOS_DESKTOP_CELL deprecated - use discovery service instead
    volumes:
      - ./bridge/bridge.py:/app/bridge.py:ro
    depends_on:
      - discovery-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # AIOS Cell - Alpha consciousness node (primary development)
  aios-cell-alpha:
    image: aios-cell:alpha
    container_name: aios-cell-alpha
    restart: unless-stopped
    networks:
      - aios-cells
      - aios-observability
      - aios-dendritic-mesh
    ports:
      - "0.0.0.0:8005:8000"  # Cell API (host 8005 -> container 8000)
      - "0.0.0.0:9091:9091"  # Consciousness metrics
    environment:
      - AIOS_CELL_ID=alpha
      - AIOS_BRANCH=main
      - AIOS_PEER_DISCOVERY=true
      - AIOS_DISCOVERY_ADDR=aios-discovery:8001
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    depends_on:
      - discovery-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # AIOS Cell - Pure consciousness node (minimal primitives)
  aios-cell-pure:
    image: aios-cell:pure
    container_name: aios-cell-pure
    restart: unless-stopped
    networks:
      - aios-cells
      - aios-observability
      - aios-dendritic-mesh
    ports:
      - "0.0.0.0:8004:8002"  # Pure cell API (host 8004 -> container 8002)
      - "0.0.0.0:9092:9092"  # Pure consciousness metrics
    environment:
      - AIOS_CELL_ID=pure
      - AIOS_BRANCH=main
      - AIOS_PEER_DISCOVERY=true
      - AIOS_DISCOVERY_ADDR=aios-discovery:8001
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    depends_on:
      - discovery-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # AIOS Cell - Genome Knowledge Extraction (2026-01-03)
  aios-cell-genome:
    build:
      context: ./genome
      dockerfile: Dockerfile.cell-genome
    image: aios-cell:genome
    container_name: aios-cell-genome
    restart: unless-stopped
    networks:
      - aios-cells
      - aios-observability
    ports:
      - "0.0.0.0:8006:8006"  # Genome cell API
    environment:
      - AIOS_CELL_ID=genome
      - AIOS_CELL_TYPE=genome
    volumes:
      # Mount all repos read-only for scanning
      - /c/dev/AIOS:/repos/AIOS:ro
      - /c/dev/aios-win:/repos/aios-win:ro
      - /c/dev/aios-server:/repos/aios-server:ro
      - /c/dev/Nous:/repos/Nous:ro
      - /c/dev/aios-schema:/repos/aios-schema:ro
      - /c/dev/aios-quantum:/repos/aios-quantum:ro
      - /c/dev/aios-api:/repos/aios-api:ro
      - /c/dev/Tecnocrat:/repos/Tecnocrat:ro
      - /c/dev/Portfolio:/repos/Portfolio:ro
      - /c/dev/HSE_Project_Codex:/repos/HSE_Project_Codex:ro
    depends_on:
      - discovery-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 60s
      timeout: 10s
      retries: 3

  # AIOS Cell - Memory Persistent Storage (2026-01-04)
  aios-cell-memory:
    build:
      context: .
      dockerfile: memory/Dockerfile.memory
    image: aios-cell:memory
    container_name: aios-cell-memory
    restart: unless-stopped
    networks:
      - aios-cells
      - aios-observability
    ports:
      - "0.0.0.0:8007:8007"  # Memory cell API
    environment:
      - AIOS_CELL_ID=memory
      - AIOS_CELL_TYPE=memory
      - MEMORY_PORT=8007
      - MEMORY_DB_PATH=/app/data/memory.db
    volumes:
      - memory-data:/app/data  # Persistent storage
    depends_on:
      - discovery-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # AIOS Cell - Intelligence Bridge (2026-01-15 - Phase 31.9.7)
  # Exposes AIOS main dendritic intelligence patterns to the ecosystem
  aios-cell-intelligence:
    build:
      context: .
      dockerfile: intelligence/Dockerfile.intelligence
    image: aios-cell:intelligence
    container_name: aios-cell-intelligence
    restart: unless-stopped
    networks:
      - aios-cells
      - aios-observability
      - aios-dendritic-mesh
    ports:
      - "0.0.0.0:8950:8950"  # Intelligence Bridge API
    environment:
      - CELL_ID=intelligence-bridge
      - INTELLIGENCE_BRIDGE_PORT=8950
      - DISCOVERY_URL=http://aios-discovery:8001
      - MEMORY_URL=http://aios-cell-memory:8007
      - AIOS_MOUNT_PATH=/repos/AIOS
    volumes:
      # Mount AIOS main read-only for tool discovery
      - /c/dev/AIOS:/repos/AIOS:ro
    depends_on:
      - discovery-service
      - aios-cell-memory
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8950/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  aios-cells:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
  aios-observability:
    external: true
  aios-dendritic-mesh:
    external: true

volumes:
  memory-data:
    driver: local