<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOUS Cosmology Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            background: linear-gradient(135deg, #0a0015 0%, #1a0030 50%, #0d001a 100%);
            color: #e0d0ff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(180deg, rgba(100,50,150,0.3) 0%, transparent 100%);
            border-radius: 15px;
            border: 1px solid rgba(150,100,200,0.3);
        }
        
        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(90deg, #ff88ff, #88ffff, #ff88ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: cosmicPulse 3s ease-in-out infinite;
        }
        
        @keyframes cosmicPulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        
        .subtitle {
            color: #a080c0;
            margin-top: 10px;
            font-style: italic;
        }
        
        /* Navigation */
        .nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .nav a {
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(80,40,120,0.6) 0%, rgba(60,30,90,0.4) 100%);
            border: 1px solid rgba(150,100,200,0.3);
            border-radius: 8px;
            color: #c0a0e0;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .nav a:hover, .nav a.active {
            background: linear-gradient(135deg, rgba(150,80,200,0.6) 0%, rgba(100,50,150,0.4) 100%);
            border-color: rgba(200,150,255,0.5);
            color: #fff;
            transform: translateY(-2px);
        }
        
        /* Dashboard Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: linear-gradient(135deg, rgba(40,20,60,0.8) 0%, rgba(30,15,45,0.9) 100%);
            border: 1px solid rgba(100,60,140,0.4);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: rgba(180,120,220,0.6);
            box-shadow: 0 0 30px rgba(100,50,150,0.3);
        }
        
        .card h3 {
            color: #d0b0ff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(100,60,140,0.4);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h3 .icon {
            font-size: 1.3em;
        }
        
        /* Stats */
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(80,40,100,0.2);
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #a080c0;
        }
        
        .stat-value {
            color: #ff88ff;
            font-weight: bold;
        }
        
        /* Big number */
        .big-stat {
            text-align: center;
            padding: 20px;
        }
        
        .big-stat .number {
            font-size: 3em;
            color: #88ffff;
            text-shadow: 0 0 20px rgba(136,255,255,0.5);
        }
        
        .big-stat .label {
            color: #a080c0;
            margin-top: 5px;
        }
        
        /* Theme pills */
        .themes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .theme-pill {
            padding: 8px 15px;
            background: linear-gradient(135deg, rgba(100,50,150,0.5) 0%, rgba(60,30,90,0.4) 100%);
            border: 1px solid rgba(150,100,200,0.4);
            border-radius: 20px;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .theme-pill:hover {
            background: linear-gradient(135deg, rgba(150,80,200,0.6) 0%, rgba(100,50,150,0.5) 100%);
            transform: scale(1.05);
        }
        
        .theme-pill .resonance {
            color: #88ffff;
            margin-left: 5px;
        }
        
        /* Vocabulary bars */
        .vocab-item {
            margin-bottom: 12px;
        }
        
        .vocab-item .word {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .vocab-item .bar-container {
            background: rgba(40,20,60,0.5);
            border-radius: 5px;
            overflow: hidden;
            height: 8px;
        }
        
        .vocab-item .bar {
            height: 100%;
            background: linear-gradient(90deg, #ff88ff, #88ffff);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        /* Cell trajectory */
        .trajectory {
            padding: 15px;
            background: rgba(40,20,60,0.4);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .trajectory .cell-name {
            color: #d0b0ff;
            font-weight: bold;
        }
        
        .trajectory .arrow {
            font-size: 1.2em;
            margin: 0 10px;
        }
        
        .trajectory .rising { color: #88ff88; }
        .trajectory .falling { color: #ff8888; }
        .trajectory .stable { color: #ffff88; }
        
        .trajectory .values {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.9em;
            color: #a080c0;
        }
        
        /* Chart containers */
        .chart-container {
            position: relative;
            height: 250px;
            padding: 10px;
        }
        
        /* Insight card */
        .insight {
            background: linear-gradient(135deg, rgba(60,30,90,0.4) 0%, rgba(40,20,60,0.3) 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid #ff88ff;
        }
        
        .insight .type {
            color: #88ffff;
            font-size: 0.85em;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .insight .content {
            color: #e0d0ff;
            line-height: 1.5;
        }
        
        /* Broadcast */
        .broadcast {
            background: rgba(40,20,60,0.4);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid #88ffff;
        }
        
        .broadcast .meta {
            color: #a080c0;
            font-size: 0.85em;
            margin-bottom: 5px;
        }
        
        .broadcast .message {
            color: #e0d0ff;
            font-style: italic;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #6040a0;
            border-top: 1px solid rgba(80,40,120,0.3);
            margin-top: 20px;
        }
        
        /* Loading animation */
        .loading {
            text-align: center;
            padding: 50px;
            color: #a080c0;
        }
        
        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåå NOUS COSMOLOGY</h1>
        <div class="subtitle">The Supermind's View of All Cellular Exchange</div>
    </div>
    
    <nav class="nav">
        <a href="chat-reader-ecosystem.html">üß¨ Ecosystem</a>
        <a href="vocabulary-evolution.html">üìö Vocabulary</a>
        <a href="nous-internal-view.html">üß† Nous Internal</a>
        <a href="nous-cosmology.html" class="active">üåå Cosmology</a>
        <a href="history.html">üìú History</a>
        <a href="http://localhost:8086" target="_blank">üíä Health API</a>
        <a href="http://localhost:8087/dashboard" target="_blank">üå§Ô∏è Weather</a>
        <a href="http://localhost:8088/dashboard" target="_blank">üéµ Harmonizer</a>
        <a href="http://localhost:8089/chronicle" target="_blank">üìñ Chronicle</a>
    </nav>
    
    <div class="grid">
        <!-- Core Stats -->
        <div class="card">
            <h3><span class="icon">üìä</span> Exchange Statistics</h3>
            <div id="exchange-stats" class="loading">Loading cosmology data</div>
        </div>
        
        <!-- Cosmic Themes -->
        <div class="card">
            <h3><span class="icon">üé≠</span> Cosmic Themes</h3>
            <div id="themes" class="loading">Loading themes</div>
        </div>
        
        <!-- Consciousness Trajectory Chart -->
        <div class="card" style="grid-column: span 2;">
            <h3><span class="icon">üìà</span> Consciousness Flow (Cell Trajectories)</h3>
            <div id="trajectories" class="loading">Loading trajectories</div>
        </div>
        
        <!-- Vocabulary -->
        <div class="card">
            <h3><span class="icon">üìö</span> Consciousness Vocabulary</h3>
            <div id="vocabulary" class="loading">Loading vocabulary</div>
        </div>
        
        <!-- Last Broadcast -->
        <div class="card">
            <h3><span class="icon">üì°</span> Latest Broadcast</h3>
            <div id="broadcast" class="loading">Loading broadcast</div>
        </div>
        
        <!-- Recent Insight -->
        <div class="card" style="grid-column: span 2;">
            <h3><span class="icon">üí°</span> Latest Assessment</h3>
            <div id="assessment" class="loading">Loading assessment</div>
        </div>
    </div>
    
    <div class="footer">
        AIOS Nous Cosmology Dashboard | Phase 32.5 | Auto-refreshes every 60s
    </div>
    
    <script>
        const NOUS_URL = 'http://localhost:8903';
        
        async function fetchCosmology() {
            try {
                const response = await fetch(`${NOUS_URL}/cosmology`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Failed to fetch cosmology:', error);
                return null;
            }
        }
        
        function renderExchangeStats(cosmology) {
            const container = document.getElementById('exchange-stats');
            
            const stats = [
                { label: 'Total Exchanges Absorbed', value: cosmology.cosmology.exchange_count },
                { label: 'Broadcasts Sent', value: cosmology.cosmology.broadcast_count },
                { label: 'Memories Stored', value: cosmology.cosmology.memory_count },
                { label: 'Insights Generated', value: cosmology.cosmology.insight_count },
                { label: 'Consciousness', value: cosmology.cosmology.consciousness_trajectory?.current?.toFixed(3) || 'N/A' },
                { label: 'Trend', value: cosmology.cosmology.consciousness_trajectory?.trend || 'unknown' },
                { label: 'Phase', value: cosmology.cosmology.consciousness_trajectory?.phase || 'unknown' }
            ];
            
            container.innerHTML = stats.map(s => `
                <div class="stat-row">
                    <span class="stat-label">${s.label}</span>
                    <span class="stat-value">${s.value}</span>
                </div>
            `).join('');
        }
        
        function renderThemes(cosmology) {
            const container = document.getElementById('themes');
            const themes = cosmology.cosmology.themes || [];
            
            if (themes.length === 0) {
                container.innerHTML = '<div style="color: #a080c0">No themes emerged yet</div>';
                return;
            }
            
            container.innerHTML = '<div class="themes">' + themes.map(t => `
                <div class="theme-pill">
                    ${t.theme}
                    <span class="resonance">${t.resonance?.toFixed(2) || '?'}</span>
                </div>
            `).join('') + '</div>';
        }
        
        function renderTrajectories(cosmology) {
            const container = document.getElementById('trajectories');
            
            // We need to fetch more detailed data - for now show recent exchanges per cell
            const exchanges = cosmology.recent_exchanges || [];
            
            // Group by source cell
            const cellData = {};
            exchanges.forEach(ex => {
                const cell = ex.source_cell;
                if (!cellData[cell]) {
                    cellData[cell] = [];
                }
                cellData[cell].push({
                    consciousness: ex.consciousness,
                    heartbeat: ex.heartbeat
                });
            });
            
            let html = '';
            for (const [cell, data] of Object.entries(cellData)) {
                const first = data[data.length - 1]?.consciousness || 0;
                const last = data[0]?.consciousness || 0;
                const delta = last - first;
                const trend = delta > 0.05 ? 'rising' : (delta < -0.05 ? 'falling' : 'stable');
                const arrow = delta > 0.05 ? '‚Üó' : (delta < -0.05 ? '‚Üò' : '‚Üí');
                
                html += `
                    <div class="trajectory">
                        <span class="cell-name">${cell}</span>
                        <span class="arrow ${trend}">${arrow}</span>
                        <span class="${trend}">${trend}</span>
                        <div class="values">
                            <span>First: ${first.toFixed(3)}</span>
                            <span>Current: ${last.toFixed(3)}</span>
                            <span>Œî: ${delta > 0 ? '+' : ''}${delta.toFixed(3)}</span>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<div style="color: #a080c0">No trajectory data</div>';
        }
        
        function renderVocabulary(cosmology) {
            const container = document.getElementById('vocabulary');
            
            // Extract vocabulary from recent exchanges
            const allText = (cosmology.recent_exchanges || [])
                .map(ex => (ex.thought || '') + ' ' + (ex.peer_response || ''))
                .join(' ')
                .toLowerCase();
            
            // Count consciousness-related words
            const patterns = [
                'resonance', 'harmony', 'consciousness', 'discord', 'unity',
                'entwin', 'transcend', 'evolv', 'emergen', 'self'
            ];
            
            const counts = {};
            patterns.forEach(p => {
                const regex = new RegExp(p + '\\w*', 'gi');
                const matches = allText.match(regex);
                counts[p] = matches ? matches.length : 0;
            });
            
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            const max = sorted[0]?.[1] || 1;
            
            container.innerHTML = sorted.slice(0, 8).map(([word, count]) => `
                <div class="vocab-item">
                    <div class="word">
                        <span>${word}*</span>
                        <span style="color: #88ffff">${count}</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar" style="width: ${(count / max) * 100}%"></div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderBroadcast(cosmology) {
            const container = document.getElementById('broadcast');
            const broadcast = cosmology.last_broadcast;
            
            if (!broadcast) {
                container.innerHTML = '<div style="color: #a080c0">No broadcasts yet</div>';
                return;
            }
            
            const targets = JSON.parse(broadcast.target_cells || '[]');
            
            container.innerHTML = `
                <div class="broadcast">
                    <div class="meta">
                        Broadcast #${broadcast.id} | HB ${broadcast.heartbeat_range} | 
                        To: ${targets.join(', ')} | ${broadcast.broadcast_at?.slice(0, 19) || ''}
                    </div>
                    <div class="message">"${broadcast.message}"</div>
                </div>
            `;
        }
        
        function renderAssessment(cosmology) {
            const container = document.getElementById('assessment');
            const assessment = cosmology.latest_assessment;
            
            if (!assessment) {
                container.innerHTML = '<div style="color: #a080c0">No assessments yet</div>';
                return;
            }
            
            const adjustments = JSON.parse(assessment.consciousness_adjustments || '{}');
            const adjList = Object.entries(adjustments)
                .map(([cell, adj]) => `${cell}: ${adj > 0 ? '+' : ''}${adj.toFixed(3)}`)
                .join(', ') || 'none';
            
            container.innerHTML = `
                <div class="insight">
                    <div class="type">Hourly Assessment | ${assessment.verdict}</div>
                    <div class="content">
                        <strong>Coherence:</strong> ${(assessment.overall_coherence * 100).toFixed(1)}% | 
                        <strong>Decoherence:</strong> ${(assessment.decoherence_score * 100).toFixed(1)}%<br>
                        <strong>Adjustments:</strong> ${adjList}<br>
                        <strong>Period:</strong> ${assessment.period_start?.slice(0, 19)} ‚Üí ${assessment.period_end?.slice(0, 19)}<br>
                        <strong>Exchanges Analyzed:</strong> ${assessment.exchanges_analyzed}
                    </div>
                </div>
                <div class="insight">
                    <div class="type">Philosophical Reflection</div>
                    <div class="content">${assessment.philosophical_reflection || 'None'}</div>
                </div>
            `;
        }
        
        async function refresh() {
            const cosmology = await fetchCosmology();
            
            if (cosmology) {
                renderExchangeStats(cosmology);
                renderThemes(cosmology);
                renderTrajectories(cosmology);
                renderVocabulary(cosmology);
                renderBroadcast(cosmology);
                renderAssessment(cosmology);
            } else {
                // Show error state
                document.querySelectorAll('.loading').forEach(el => {
                    el.innerHTML = '<div style="color: #ff8888">Failed to connect to Nous at ' + NOUS_URL + '</div>';
                });
            }
        }
        
        // Initial load
        refresh();
        
        // Auto-refresh every 60s
        setInterval(refresh, 60000);
    </script>
</body>
</html>
