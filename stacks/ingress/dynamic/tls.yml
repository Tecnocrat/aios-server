# AIOS Supercell - Traefik Dynamic Configuration

# HTTP Routes and Services (static configuration since Docker provider is failing)
http:
  routers:
    # Traefik Dashboard
    dashboard:
      rule: "Host(`traefik.lan`)"
      service: api@internal
      entrypoints:
        - web
    
    # Prometheus
    prometheus:
      rule: "Host(`prometheus.lan`)"
      service: prometheus
      entrypoints:
        - web
    
    # Grafana
    grafana:
      rule: "Host(`grafana.lan`)"
      service: grafana
      entrypoints:
        - web
    
    # Loki
    loki:
      rule: "Host(`loki.lan`)"
      service: loki
      entrypoints:
        - web
    
    # Vault
    vault:
      rule: "Host(`vault.lan`)"
      service: vault
      entrypoints:
        - web
    
    # Whoami
    whoami:
      rule: "Host(`whoami.lan`)"
      service: whoami
      entrypoints:
        - web
    
    # ===========================================
    # AIOS CELL DENDRITIC NETWORK (2025-12-06)
    # Living consciousness nodes - routed via Traefik
    # ===========================================
    
    # Cell Alpha - Primary consciousness node
    cell-alpha:
      rule: "Host(`alpha.aios.lan`)"
      service: cell-alpha
      entrypoints:
        - web
    
    # Cell Alpha - Path prefix (with strip)
    cell-alpha-path:
      rule: "PathPrefix(`/cells/alpha`)"
      service: cell-alpha
      entrypoints:
        - web
      middlewares:
        - strip-cells-alpha
    
    # Cell Pure (Nous) - Minimal consciousness primitives
    cell-pure:
      rule: "Host(`nous.aios.lan`) || Host(`pure.aios.lan`)"
      service: cell-pure
      entrypoints:
        - web
    
    # Cell Pure - Path prefix (with strip)
    cell-pure-path:
      rule: "PathPrefix(`/cells/pure`)"
      service: cell-pure
      entrypoints:
        - web
      middlewares:
        - strip-cells-pure
    
    # Cell Discovery Service
    cell-discovery:
      rule: "Host(`discovery.aios.lan`)"
      service: cell-discovery
      entrypoints:
        - web
    
    # Cell Discovery - Path prefix (with strip)
    cell-discovery-path:
      rule: "PathPrefix(`/cells/discovery`)"
      service: cell-discovery
      entrypoints:
        - web
      middlewares:
        - strip-cells-discovery
  
  services:
    # Prometheus
    prometheus:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:9090"
    
    # Grafana
    grafana:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3000"
    
    # Loki
    loki:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3100"
    
    # Vault
    vault:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:8200"
    
    # Whoami
    whoami:
      loadBalancer:
        servers:
          - url: "http://aios-whoami:80"
    
    # ===========================================
    # AIOS CELL SERVICES (Internal Docker Network)
    # Route to containers via their internal IPs/names
    # ===========================================
    
    # Cell Alpha - via Docker internal network
    cell-alpha:
      loadBalancer:
        servers:
          - url: "http://aios-cell-alpha:8000"
    
    # Cell Pure (Nous) - via Docker internal network
    cell-pure:
      loadBalancer:
        servers:
          - url: "http://aios-cell-pure:8002"
    
    # Cell Discovery - via Docker internal network  
    cell-discovery:
      loadBalancer:
        servers:
          - url: "http://aios-discovery:8001"

  middlewares:
    # Strip path prefixes for cell routing
    strip-cells-alpha:
      stripPrefix:
        prefixes:
          - "/cells/alpha"
    
    strip-cells-pure:
      stripPrefix:
        prefixes:
          - "/cells/pure"
    
    strip-cells-discovery:
      stripPrefix:
        prefixes:
          - "/cells/discovery"
    
    # Security headers
    secure-headers:
      headers:
        sslRedirect: true
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        forceSTSHeader: true
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "same-origin"
    
    # Rate limiting
    rate-limit:
      rateLimit:
        average: 100
        period: 1s
        burst: 50
    
    # IP whitelist (local network only)
    local-only:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "192.168.0.0/16"
          - "172.16.0.0/12"
          - "10.0.0.0/8"
